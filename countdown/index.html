<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<section id="main">
    <span id="p-time-to-go">Playing in <span id="time-to-go"></span></span>
    <span id="p-time-to-ny"> New Year in <span id="time-to-ny"></span></span><br>
    <div id="ytplayer"></div><br>
    <span id="text">If you play '<span id="vname"></span>' at <span id="time"></span> on New Year's Eve, <span id="caption"></span></span>
</section>

<section id="video-error">
    <p>
        Invalid video tag or specified time is after video ends <br> <a href="/ifyouplay/">Take me back</a>
    </p>
</section>


<style>

    #video-error {
        display: none;
    }

</style>

<script>
    getVar = function(item){
        var svalue = location.search.match(new RegExp("[\?\&]" + item + "=([^\&]*)(\&?)","i"));
        return svalue ? decodeURIComponent( svalue[1].replace(/\+/g, "%20") ) : "";
    }

    millisToHMS = function(millis) {
        var seconds = millis / 1000;
        var hours = parseInt( seconds / 3600 );
        seconds = seconds % 3600;
        var minutes = parseInt( seconds / 60 );
        seconds = Math.round(seconds % 60);
        return [hours, minutes, seconds]
    }


    //get URL vars
    var video_uri = getVar("uri");
    var video_caption = getVar("caption");

    var video_tm = Number(getVar("m"));
    var video_ts = Number(getVar("s"));

    var video_time;
    var video_id;
    var millisToNY;
    var millisToPlay;
    var targetMillis = (new Date("2018")).getTime();
    var playing = false;

    //hide text if no caption
    if (! video_caption) {
        $("#text").hide();
    }

    //scrap vid id from uri
    video_id = video_uri.match(/[a-zA-Z0-9_-]{11}/)

    // Load the IFrame Player API code asynchronously
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/player_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // Replace the 'ytplayer' element with an <iframe> and
    // YouTube player after the API code downloads.
    var player;
    function onYouTubePlayerAPIReady() {
        player = new YT.Player('ytplayer', {
        height: '360',
        width: '640',
        videoId: video_id,

        events: {
            onError: function(ev) {
                $("#main").hide();
                $("#video-error").show();
            },
            onReady: function(ev) {
                //set title
                $("#vname").html(player.getVideoData().title);


                if (video_tm || video_ts) {
                    video_time = ((+video_tm) * 60 + (+video_ts)) * 1000;
                    if (video_time > player.getDuration() * 1000) {
                        $("#main").hide();
                        $("#video-error").show();
                    }
                } else {
                    video_time = player.getDuration() * 1000;
                }

                millisToNY = targetMillis - Date.now();
                millisToPlay = millisToNY - video_time;

                setInterval(function() {
                    millisToNY = targetMillis - Date.now();
                    millisToPlay = millisToNY - video_time;

                    var hmsToPlay = millisToHMS(millisToPlay);
                    $("#time-to-go").html(`${hmsToPlay[0]}:${hmsToPlay[1]}:${hmsToPlay[2]}`);
                    var hmsToNY = millisToHMS(millisToNY);
                    $("#time-to-ny").html(`${hmsToNY[0]}:${hmsToNY[1]}:${hmsToNY[2]}`);

                    if (millisToPlay <= 2000 && !playing) {
                        player.playVideo()
                        playing = true;
                    }
                    

                }, 100);
                setInterval(function(){//skip video to correct time if buffering or already started etc.
                    if (playing && ((player.getCurrentTime() > -(millisToPlay/1000) + 10) || (player.getCurrentTime() < -(millisToPlay/1000) - 10))) {
                        player.seekTo(-millisToPlay / 1000, true)
                    }
                }, 3000);
            }
        }
        });
    }

    //set caption
    $("#caption").html(video_caption);
</script>
